rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // 사용자 정보 컬렉션
    match /users/{userId} {
      // 모든 사용자가 공개 정보(verificationStatus, companyName 등)를 읽을 수 있음
      // 서비스 목록에서 인증 기업 표시를 위해 필요
      allow read: if true;
      
      // 인증된 사용자는 자신의 정보만 수정 가능
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // 관리자는 모든 사용자 정보 수정 가능
      allow write: if request.auth != null && 
        (request.auth.token.email == "admin@gmail.com" || 
         request.auth.token.email == "kimhyeongmin@gmail.com");
    }
    
    // 서비스 관련 컬렉션
    match /services/{serviceId} {
      // 모든 사용자가 읽기 가능 (로그인 불필요)
      allow read: if true;
      
      // 작성자만 수정 가능 (기존 문서)
      allow update, delete: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // 새 문서 생성 시
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
      
      // 관리자는 모든 서비스에 접근 가능
      allow read, write: if request.auth != null && 
        (request.auth.token.email == "admin@gmail.com" || 
         request.auth.token.email == "kimhyeongmin@gmail.com");
    }
    
    // 게시물 관련 컬렉션
    match /posts/{postId} {
      // 모든 사용자가 읽기 가능 (로그인 불필요)
      allow read: if true;
      
      // 작성자만 수정 가능
      allow update, delete: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // 새 게시물 생성
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
      
      // 관리자는 모든 게시물에 접근 가능
      allow read, write: if request.auth != null && 
        (request.auth.token.email == "admin@gmail.com" || 
         request.auth.token.email == "kimhyeongmin@gmail.com");
    }
    
    // 관리자 전용 컬렉션
    match /admin/{document=**} {
      allow read, write: if request.auth != null && 
        (request.auth.token.email == "admin@gmail.com" || 
         request.auth.token.email == "kimhyeongmin@gmail.com");
    }
    
    // 통계 및 분석 데이터
    match /analytics/{document=**} {
      allow read, write: if request.auth != null && 
        (request.auth.token.email == "admin@gmail.com" || 
         request.auth.token.email == "kimhyeongmin@gmail.com");
    }
    
    // 설정 및 구성 데이터
    match /config/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (request.auth.token.email == "admin@gmail.com" || 
         request.auth.token.email == "kimhyeongmin@gmail.com");
    }
    
    // 기타 모든 문서는 인증된 사용자만 접근 가능
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
